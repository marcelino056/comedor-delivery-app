name: Deploy to Amber VPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

j          sudo pm2 start ecosystem.config.js
          sudo pm2 save
          
          # Verificar que la aplicaciÃ³n responda
          sleep 5
          if curl -f http://localhost:3007 > /dev/null 2>&1; then
            echo "âœ… AplicaciÃ³n respondiendo correctamente en puerto 3007"
          else
            echo "âŒ Error: La aplicaciÃ³n no responde en puerto 3007"
            exit 1
          fi
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests (if available)
      run: npm test --if-present

    - name: Deploy to Amber VPS
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          echo "ğŸš€ Iniciando deployment..."
          
          # Navegar al directorio del proyecto
          cd /var/www/comedor-app || {
            echo "âŒ Error: Directorio del proyecto no encontrado"
            exit 1
          }
          
          echo "ğŸ“‚ Directorio actual: $(pwd)"
          
          # Hacer backup de la configuraciÃ³n actual
          echo "ğŸ“¦ Creando backup..."
          sudo cp -r . /var/www/backups/comedor-app-$(date +%Y%m%d-%H%M%S) || echo "âš ï¸  Warning: No se pudo crear backup"
          
          # Detener la aplicaciÃ³n PM2
          echo "â¹ï¸  Deteniendo aplicaciÃ³n..."
          sudo pm2 stop comedor-app || echo "âš ï¸  AplicaciÃ³n no estaba corriendo"
          
          # Actualizar cÃ³digo desde GitHub
          echo "ğŸ“¥ Actualizando cÃ³digo desde GitHub..."
          sudo git fetch origin
          sudo git reset --hard origin/main
          sudo chown -R www-data:www-data .
          
          # Instalar dependencias
          echo "ğŸ“¦ Instalando dependencias..."
          sudo npm ci --production
          
          # Verificar configuraciÃ³n
          echo "ğŸ” Verificando archivos importantes..."
          [ -f "server.js" ] && echo "âœ… server.js encontrado" || echo "âŒ server.js NO encontrado"
          [ -f "package.json" ] && echo "âœ… package.json encontrado" || echo "âŒ package.json NO encontrado"
          
          # Verificar MongoDB estÃ¡ corriendo
          echo "ğŸ” Verificando MongoDB..."
          sudo systemctl is-active mongod && echo "âœ… MongoDB estÃ¡ corriendo" || {
            echo "âš ï¸  MongoDB no estÃ¡ corriendo, intentando iniciar..."
            sudo systemctl start mongod
          }
          
          # Crear/actualizar configuraciÃ³n de PM2
          echo "ï¿½ Actualizando configuraciÃ³n de PM2..."
          cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'comedor-app',
    script: './server.js',
    cwd: '/var/www/comedor-app',
    instances: 1,
    env: {
      NODE_ENV: 'production',
      PORT: 3005
    },
    error_file: '/var/log/pm2/comedor-app-error.log',
    out_file: '/var/log/pm2/comedor-app-out.log',
    log_file: '/var/log/pm2/comedor-app.log',
    time: true,
    watch: false,
    restart_delay: 5000,
    max_restarts: 10
  }]
};
EOF
          
          # Reiniciar la aplicaciÃ³n con PM2
          echo "ğŸ”„ Reiniciando aplicaciÃ³n..."
          sudo pm2 start ecosystem.config.js || sudo pm2 restart comedor-app
          sudo pm2 save
          
          # Verificar que la aplicaciÃ³n estÃ© corriendo
          sleep 5
          if sudo pm2 show comedor-app | grep -q "online"; then
            echo "âœ… AplicaciÃ³n reiniciada correctamente"
            echo "ğŸŒ AplicaciÃ³n disponible en el puerto 3005"
          else
            echo "âŒ Error: La aplicaciÃ³n no se pudo iniciar"
            echo "ğŸ“‹ Logs de la aplicaciÃ³n:"
            sudo pm2 logs comedor-app --lines 20
            exit 1
          fi
          
          # Verificar conectividad
          echo "ğŸ” Verificando conectividad..."
          sleep 5
          if curl -f http://localhost:3005 > /dev/null 2>&1; then
            echo "âœ… AplicaciÃ³n responde correctamente"
          else
            echo "âš ï¸  Warning: La aplicaciÃ³n puede no estar respondiendo aÃºn"
          fi
          
          echo "ğŸ‰ Â¡Deployment completado exitosamente!"
          echo "ğŸ“Š Estado de la aplicaciÃ³n:"
          sudo pm2 status

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment exitoso a Amber VPS"
        else
          echo "âŒ Deployment fallÃ³"
        fi
